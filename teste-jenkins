pipeline {
    agent any
    environment {
        SVN_ACBR = 'https://svn.code.sf.net/p/acbr/code/trunk2/'
        DOCKER_IMAGE = 'matheusconf/lazarus-crossbuilder:lazarus-2.2.4-android'
    }
    options { disableConcurrentBuilds() }
    parameters {
        string(
            name: 'RevSVN',
            defaultValue: '',
            description: 'Defina a revisão estável do SVN do ACBR (deixe vazio para a última revisão)'
        )
    }
    agent {
        docker {
            image "${DOCKER_IMAGE}"
            args '--privileged --rm -u 0'
            reuseNode true
        }
    }
    stages {
        stage('Sincronizando Fontes') {
            steps {
                script {
                    checkout([
                        $class: 'SubversionSCM',
                        locations: [
                            [remote: "${SVN_ACBR}${params.RevSVN}"]
                        ],
                        workspaceUpdater: [$class: 'UpdateWithCleanUpdater']
                    ])
                }
            }
        }
        stage('Compilando LPI') {
            steps {
                sh 'chmod 777 -R trunk2'
                sh 'bash stage_1.sh'
            }
        }
        stage('Compilando ACBrLibBase e Build .aar') {
            steps {
                sh 'bash stage_2.sh'
            }
        }
    }
}
