pipeline {
    agent any
    options { disableConcurrentBuilds() }
    environment {
        SVN_PROJETOS = 'https://svn.code.sf.net/p/acbr/code/trunk2/Projetos'
        SVN_DLL = 'https://svn.code.sf.net/p/acbr/code/trunk2/DLLs'
        DOCKER_IMAGE = 'matheusconf/lazarus-crossbuilder:lazarus-2.2.4'

    }
    stages {
        stage('Fontes SVN') {
            steps {
                script {
                    checkout([
                        $class: 'SubversionSCM',
                        locations: [
                            [remote: SVN_PROJETOS],
                            [remote: SVN_DLL]
                        ],
                        workspaceUpdater: [$class: 'UpdateWithCleanUpdater']
                    ])
                }
            }
        }
        stage('Teste Workspace') {
            agent {
                docker {
                    image DOCKER_IMAGE
                    args '--privileged -u 0'
                    reuseNode true
                }
            }
            steps {
                script {
                    sh '''
                    export ACBR_HOME=/var/jenkins_home/workspace/Teste-Pipeline
                    export ANDROID_HOME=/opt/ides/lamw/sdk
                    cd $ACBR_HOME/Projetos/ACBrLib/Fontes/NFe
                    lazbuild --bm=android-armeabi-v7a ACBrLibNFeConsoleMT.lpi
                    lazbuild --bm=android-arm64-v8a ACBrLibNFeConsoleMT.lpi
                    cp  $ACBR_HOME/Projetos/ACBrLib/Fontes/NFe/bin/Android/jniLibs $ACBR_HOME/projetos/ACBrLib/Android/NFe/ACBrLibNFe -r
                    '''
                }
            }
        }
    }
}
